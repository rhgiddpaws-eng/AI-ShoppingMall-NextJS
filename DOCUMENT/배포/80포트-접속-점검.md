# 80 포트 접속 안 될 때 점검 순서

Let's Encrypt 인증 시 "Timeout during connect (likely firewall problem)" 이 나올 때, **어디에서 막히는지** 찾기 위한 체크리스트입니다.

---

## 연결 경로

```
인터넷(Let's Encrypt) → 112.214.35.103:80 (공인IP)
    → 공유기 포트포워딩
    → 192.168.200.121:80 (내 PC)
    → Windows 방화벽
    → Docker 80번 포트
    → certbot 컨테이너
```

아래 순서대로 확인하고, **몇 번에서 막히는지** 적어두면 원인을 좁힐 수 있습니다.

---

## 1단계: PC에서 80 포트가 열려 있는지 (certbot 실행 중에)

1. 터미널에서 `obtain-cert.sh` 를 **실행한 상태**로 둡니다 (certbot이 대기하는 동안).
2. **다른** PowerShell 또는 CMD 창을 열고:

```powershell
netstat -an | findstr ":80 "
```

**기대 결과:**  
`0.0.0.0:80` 또는 `[::]:80` 이 **LISTENING** 으로 보여야 합니다.

- **0.0.0.0:80 LISTENING** → 이 PC에서는 모든 IP로 들어오는 80을 받을 준비가 된 것. 다음 단계로.
- **127.0.0.1:80 LISTENING** 만 보임 → 로컬만 받고 있어서 외부/LAN 접속 불가. Docker 포트를 `0.0.0.0:80:80` 으로 바인딩했는지 확인 (이미 nginx-compose.yml 에 반영됨).
- **80 번이 아예 없음** → certbot이 80을 안 쓰는 상태. nginx가 먼저 80을 잡고 있진 않은지, `obtain-cert.sh` 가 nginx 중지 후 certbot 실행하는지 확인.

---

## 2단계: 같은 LAN에서 PC로 접속 (192.168.200.121)

- **휴대폰**을 **같은 Wi‑Fi**에 연결한 뒤 브라우저에서:
  - `http://192.168.200.121`
- 또는 **같은 네트워크의 다른 PC**에서 위 주소로 접속.

**기대 결과:**  
certbot이 떠 있는 동안에는 “Connection refused”가 아니고, 간단한 응답이 나오거나 최소한 연결은 되어야 합니다. (에러 페이지라도 80으로 들어온 것.)

- **여기서 안 됨** → **이 PC(방화벽 또는 Docker)** 쪽 문제.
- **여기서 됨** → 이 PC와 Docker는 정상. **3단계(공유기/외부)** 쪽 문제 가능성 큼.

---

## 3단계: Windows 방화벽 인바운드 80 허용

1. **Win + R** → `wf.msc` 입력 → Enter.
2. **인바운드 규칙** → 오른쪽 **새 규칙**.
3. **포트** → 다음 → **TCP**, **특정 로컬 포트**: `80` → 다음.
4. **연결 허용** → 다음.
5. **도메인, 개인, 공용** **전부 체크** → 다음.
6. 이름 예: `HTTP 80 인바운드` → 마침.

이렇게 해도 2단계에서 안 되면, **방화벽 끄고** (테스트만) 다시 2단계 시도.  
방화벽 끄면 되면 → 방화벽 규칙이 제대로 안 먹은 것이므로 규칙 다시 확인.

---

## 4단계: 내부 IP가 바뀌지 않았는지

- **192.168.200.121** 이 지금 이 PC IP가 맞는지 확인.

```powershell
ipconfig
```

- **IPv4 주소**가 192.168.200.121이어야 공유기 포트포워딩과 맞습니다.
- DHCP라서 바뀌었다면, 공유기에서 이 PC를 **고정 IP(192.168.200.121)** 로 잡거나, 포트포워딩 규칙의 **내부 IP**를 현재 IPv4로 수정.

---

## 5단계: 공유기 포트포워딩 재확인

- **외부 포트**: 80  
- **내부 IP**: 192.168.200.121 (또는 4단계에서 확인한 이 PC IP)  
- **내부 포트**: 80  
- **프로토콜**: TCP (또는 TCP+UDP 중 TCP 포함)  
- 규칙 **활성화** 여부.

저장 후 **공유기 한 번 재부팅** 해보기.

---

## 6단계: 외부에서 80 포트 열림 여부

- **휴대폰**에서 **Wi‑Fi 끄고 데이터만** 켠 뒤:
  - `http://112.214.35.103` 접속.
- 또는 PC에서:
  - https://www.portchecker.co 에서 **112.214.35.103**, 포트 **80** 체크.

- **2단계는 되는데 6단계만 안 됨** → 공유기 포트포워딩이 실제로 동작하지 않거나, **통신사(ISP)가 80 포트 인바운드를 막는 경우**입니다. (가정용 회선에서 흔함.)
- **6단계에서 80 열림** → Let's Encrypt도 들어올 수 있어야 하므로, 그 상태에서 `obtain-cert.sh` 다시 실행.

---

## 요약 표

| 단계 | 확인 내용 | 안 되면 의심 |
|------|-----------|----------------|
| 1 | `netstat` 에 0.0.0.0:80 LISTENING | Docker 바인딩 / nginx가 80 선점 |
| 2 | 같은 LAN에서 http://192.168.200.121 | PC 방화벽 / Docker |
| 3 | 방화벽 인바운드 TCP 80 규칙 | Windows 방화벽 |
| 4 | ipconfig 로 192.168.200.121 맞는지 | 포트포워딩 대상 IP 잘못됨 |
| 5 | 공유기 80 → 192.168.200.121:80 | 공유기 설정 / 재부팅 |
| 6 | 외부에서 112.214.35.103:80 | 공유기 또는 **ISP 80 차단** |

**6단계까지 다 했는데 외부에서만 안 되면** → 통신사가 80을 막는 경우라, 그 환경에서는 80을 “열 수” 없습니다. 그때는 DNS-01 방식으로 인증서를 받는 수밖에 없습니다.
